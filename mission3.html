<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>MindAR: targets.mind → xray.png 오버레이</title>

    <!-- A-Frame & MindAR (Image) -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body { margin: 0; height: 100%; overflow: hidden; background: #000; }
      /* 버튼 & 힌트 */
      .btns { position: fixed; z-index: 10; left: 12px; bottom: 12px; display: flex; gap: 8px; }
      .btns button { padding: 8px 12px; border-radius: 10px; border: 0; font-weight: 700; }
      .hint { position: fixed; z-index: 10; right: 12px; bottom: 12px; color: #fff; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; opacity: .85; text-align: right; }
      .hint a { color: #fff; text-decoration: underline; }
      /* MindAR 스캐닝 UI가 버튼을 가리지 않도록 */
      .mindar-ui-overlay { bottom: 64px !important; }
      /* 혹시라도 자산 이미지가 DOM에 보이지 않도록 강제 숨김 */
      a-assets, a-assets > * { display: none !important; }
      /* 인앱 브라우저 경고 배경 */
      .ib-warning{position:fixed;z-index:20;inset:0;background:rgba(0,0,0,.85);color:#fff;display:none;align-items:center;justify-content:center;text-align:center;padding:24px}
      .ib-warning .box{max-width:520px}
      .ib-warning button{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;font-weight:700}
      .ib-warning{position:fixed;z-index:20;inset:0;background:rgba(0,0,0,.85);color:#fff;display:none;align-items:center;justify-content:center;text-align:center;padding:24px}
  .ib-warning .box{max-width:520px}
  .ib-warning button{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;font-weight:700}
      /* 디버그 패널 */
      .diag { position: fixed; left: 12px; top: 12px; z-index: 15; background: rgba(0,0,0,.55); color:#fff; padding:8px 10px; border-radius:10px; font:12px/1.4 ui-sans-serif, system-ui; max-width: 86vw; }
    </style>
  </head>
  <body>
    <!-- 인앱 브라우저(카카오톡 등) 안내 -->
    <div id="ibWarning" class="ib-warning">
      <div class="box">
        <h3 style="margin:0 0 8px">카메라가 실행되지 않나요?</h3>
        <p style="opacity:.9">카카오톡/인스타그램 등 <b>인앱 브라우저</b>에서는 카메라가 차단될 수 있어요.<br>오른쪽 상단 메뉴에서 <b>기본 브라우저로 열기</b>를 선택하거나 아래 버튼을 눌러주세요.</p>
        <button id="openExternal">외부 브라우저에서 열기</button>
        <p style="margin-top:10px;opacity:.8">또는 아래 <b>Start</b> 버튼을 눌러 카메라 권한을 허용해 주세요.</p>
      </div>
    </div>

    <!-- 컨트롤(선택) -->
    <div class="btns">
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
    </div>
    <div class="hint">타깃이 인식되면 <strong>xray.png</strong>가 나타납니다.</div>
    <div class="diag" id="diag">diag</div>

    <!-- AR 씬 -->
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      renderer="colorManagement: true; physicallyCorrectLights: true"
      device-orientation-permission-ui="enabled: true"
      mindar-image="imageTargetSrc: images/mission3/targets.mind; autoStart: true; uiLoading: true; uiScanning: true; uiError: true;">

      <!-- 에셋 프리로드 -->
      <a-assets>
        <img id="xray" src="images/mission3/xray.png" crossorigin="anonymous" />
      </a-assets>

      <!-- 카메라 -->
      <a-camera position="0 0 0" look-controls-enabled="false"></a-camera>

      <!-- 타깃(0번) 위에 xray.png 오버레이: 기본은 숨김 상태 -->
      <a-entity id="anchor" mindar-image-target="targetIndex: 0" visible="false">
        <a-image src="#xray"
                 width="0.35" height="0.35"
                 position="0 0 0"
                 rotation="0 0 0"
                 material="transparent: true; alphaTest: 0.001">
        </a-image>
      </a-entity>

      <!-- 조명(선택 사항) -->
      <a-entity light="type: ambient; intensity: 1.0"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const anchor = document.getElementById('anchor');
      const ibWarning = document.getElementById('ibWarning');
      const openExternalBtn = document.getElementById('openExternal');

      // 인앱 브라우저 감지 (카카오/인스타/페북/네이버 등)
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isInApp = /(KAKAOTALK|FBAN|FBAV|Instagram|NAVER|DaumApps)/i.test(ua);
      if (isInApp) ibWarning.style.display = 'flex';
      openExternalBtn?.addEventListener('click', () => {
        const url = location.href;
        location.href = `intent://${url.replace(/^https?:\/\//,'')}#Intent;scheme=https;package=com.android.chrome;end`;
      });

      // MindAR: 타깃 인식 시에만 보이기
      anchor.addEventListener('targetFound', () => anchor.setAttribute('visible', 'true'));
      anchor.addEventListener('targetLost', () => anchor.setAttribute('visible', 'false'));

      // 안전 시작 (여러 경로로 시도)
      async function safeStart(){
        try {
          const system = sceneEl.systems['mindar-image-system'];
          if (system && !system._active) await system.start();
        } catch(e){ console.warn('AR start error:', e); }
      }
      sceneEl.addEventListener('renderstart', safeStart);
      // 재시도 로직(일부 기기에서 첫 시도 실패 대비)
      let retries = 0;
      const retryTimer = setInterval(async ()=>{
        const system = sceneEl.systems['mindar-image-system'];
        if (system?._active || retries>5) return clearInterval(retryTimer);
        retries++;
        await safeStart();
      }, 1200);
      ['click','touchstart'].forEach(ev => window.addEventListener(ev, safeStart, { once:false }));
      startBtn?.addEventListener('click', safeStart);
      stopBtn?.addEventListener('click', async () => {
        const system = sceneEl.systems['mindar-image-system'];
        await system?.stop();
      });

      // 추가 진단: 카메라 접근 및 디바이스 나열
      async function preflight(){
        const out = [];
        out.push(`secure:${location.protocol==='https:'} ua:${navigator.userAgent.split(' ').slice(-3).join(' ')}`);
        try{
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d=>d.kind==='videoinput');
          out.push(`cams:${cams.length}`);
        }catch(e){ out.push('enumerateDevices err'); }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
          stream.getTracks().forEach(t=>t.stop());
          out.push('gum:ok');
        } catch(e){
          out.push(`gum:${e.name}`);
          if (e.name==='NotReadableError') alert('카메라가 다른 앱에서 사용 중일 수 있어요. 모든 카메라 앱을 종료 후 다시 시도해주세요.');
          if (e.name==='NotAllowedError') alert('카메라 권한이 차단되어 있어요. 사이트 권한에서 카메라를 허용해 주세요.');
          if (e.name==='NotFoundError') alert('사용 가능한 카메라를 찾지 못했습니다.');
        }
        document.getElementById('diag').textContent = out.join(' | ');
      }
      preflight();
          return;
        }
        try {
          // 권한 프롬프트 유발
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
          stream.getTracks().forEach(t => t.stop());
        } catch (e) {
          alert('카메라 권한이 차단되어 있습니다. 사이트 권한에서 카메라를 허용해 주세요.');
          console.error('권한 거부 또는 오류:', e);
        }
      })();

      // 콘솔 로그(문제 진단용)
      sceneEl.addEventListener('arError', (e) => console.error('MindAR arError:', e?.detail));
      sceneEl.addEventListener('arReady', () => console.log('MindAR ready'));
    </script>
  </body>
</html>
